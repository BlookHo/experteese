/**
 * Created by aleks_i on 25.03.16.
 */


var imageUrl = '<%= @image_url %>';
console.log("IN display_image_by_url: imageUrl = " + imageUrl );
var imageFileName = '<%= @image_file_name %>';
console.log("IN display_image_by_url: imageFileName = " + imageFileName );
var imagePath = '<%= @image_path %>';
console.log("IN display_image_by_url: imagePath = " + imagePath );


//var tempFileImage  = '<%= @image_tempfile %>';
//console.log("IN display_image_by_url: tempFileImage = " + tempFileImage );
var imageTempfilePath  = '<%= @image_tempfile_path %>';
console.log("IN display_image_by_url: imageTempfilePath = " + imageTempfilePath );
var imageFileName  = '<%= @image_tempfile_name %>';
console.log("IN display_image_by_url: imageFileName = " + imageFileName );

var nameImage = imageFileName.slice(0,-4) ;  // put away . file .jpr
$('.image_display h2.up').append().html(nameImage);

var dirFile = '<%= @image_dir %>';
console.log("IN display_image_by_url: dirFile = " + dirFile );
var pathImage = dirFile + imageFileName;
console.log("IN display_image_by_url: pathImage = " + pathImage );
var pathLongImage = "app/assets/images/pictures/" + imageFileName;
console.log("IN display_image_by_url: pathLongImage = " + pathLongImage );


$(".img-center img").attr({alt: "Selected Image", src: pathImage, title: "Selected image" });
//$(".img-center img").attr({alt: "Selected Image", src: dirFile, title: "Selected image" });
$(".image_diag .scale .small_img_box img").attr({alt: "Selected Image", src: pathImage, title: "Selected image" });
$('.img-left-side .button__results').css({"display": "none"});

var titleImage = "Click this image to analyse it";
$('.img-title').append().html(titleImage);

$('.form_select').remove('.form_select');
$('.load_image').empty().html("<%= j render 'images/button_load' -%>");
$('.select_image').html("<%= j render 'images/button_select' -%>");
$('.modal_list_results').html("<%= j render 'images/button_list_results' -%>");

//$( ".img-center").unbind( "click" );


$('.img-center').unbind( "click" ).click(function by_url(event) {  //ajax
//    $('.img-center').on("click", function(event) {  //ajax
//        $('.img-center').off("click");
    console.log("IN display_image_by_url - in onclick function(): selected nameImage = " + nameImage );
    console.log("link clicked: selectedImage: imageFileName =  " + imageFileName);
    //$('.image_diag h2.down').append().html(selectedImage);
    event.stopImmediatePropagation(); // would stop the event from bubbling to parent elements,

    //$('.image_display .image_diag .indicator .outer-circle').removeClass("show");
    $('.image_display .image_diag .indicator .outer-circle').css({"display": "none"});
    $('.image_display .image_diag .scale .small_img_box').css({"display": "none"});
    $('.image_display .indic-circ').css({"display": "none"});
    $('.image_display .image_diag h2.down').css({"display": "none"});
    // not prevent other click handlers on the same element from firing.

    $.ajax({
        type: "get",
        // url: "diag_image",
        url: "analyse_uploaded_file",
//        data: { image_file: imageFileName, file_path: imageTempfilePath },
        data: { image_file: imageFileName, file_path: pathLongImage },


        dataType: 'json'
    }).done(function (data_return) {
        console.log("success Analyse Uploaded file:  " + data_return.notice );

        var diagReturned = "diag_Hk: " + data_return.result_hk + "; time: " + data_return.diag_time + " ms;";
        $('.image_display .image_diag h2.down').css({"display": "block"}).empty()
                .before().append().html(diagReturned).fadeOut(4500);

        var resultHK = data_return.result_hk;
        console.log("resultHK:  " + resultHK );
        var resultColorIndicator = data_return.color_indicator;
        console.log("resultColorIndicator:  " + resultColorIndicator );

        var imgScalePos = data_return.img_scale_pos + "%";
        console.log("imgScalePos:  " + imgScalePos );

//        var newLeft ;
//        var newClass;
        //$('.image_display .image_diag .indicator .outer-circle').addClass('show ');
        $('.image_display .image_diag .indicator .outer-circle').css({
            "display": "block",
            "left": "43.75%",
            "border-color": resultColorIndicator
        });
        $('.image_display .indic-circ').css({
            "display": "block",
            "left": "43.75%",
            "border-color": resultColorIndicator
        });

        $('.image_display .image_diag .scale .small_img_box').css({"left": imgScalePos, "display": "block" });
//        newClass = $('.image_display .image_diag .indicator .outer-circle').attr("class");
//        console.log("attr: newClass = " + newClass);
//        newLeft = $('.image_display .image_diag .indicator .outer-circle').css("left");
//        console.log("attr border: newLeft = " + newLeft);
        $('.image_display .image_diag .scale').css({
            "display": "block"
//                "border-color": function(){
//                    return isNaN(resultHK) ? '#000' : resultHK < 200 ? '#f00' : resultHK < 350 ? '#0ff' : '#f90';
//                }
//                "border-color": indicator_color(resultHK)
//                "border-color": resultColorIndicator
        });
        $('.button__results').css({"display": "block"});
    })
            .fail(function (data_return) {
                console.log("error: data_return = " + data_return);
            });
});



$('button.button__results.yes').unbind( "click" ).click(function save_results(event) {  //ajax
    console.log("button__results  .yes clicked: imageFileName =  " + imageFileName);
    console.log("button__results  .yes clicked: imageTempfilePath =  " + imageTempfilePath);
    console.log("button__results  .yes clicked: pathLongImage =  " + pathLongImage);
    event.stopImmediatePropagation(); // would stop the event from bubbling to parent elements,
    $('.button__results').css({"display": "none"});
});


$('button.button__results.no').unbind( "click" ).click(function save_results(event) {  //ajax
    console.log("display by url: button__results  .no clicked: imageFileName =  " + imageFileName);
    console.log("button__results  .no clicked: imageTempfilePath =  " + imageTempfilePath);
    console.log("button__results  .no clicked: pathLongImage =  " + pathLongImage);
    event.stopImmediatePropagation(); // would stop the event from bubbling to parent elements,
    $.ajax({
        type: "get",
        url: "clear_diag_result",
        data: { image_file: imageFileName, file_path: imageTempfilePath },
        dataType: 'json'
    }).done(function (data_return) {
        console.log("success Analyse Uploaded file:  " + data_return.notice );
        $('.button__results').css({"display": "none"});
    })
            .fail(function (data_return) {
                console.log("error: data_return = " + data_return);
            });
});


//.bind('click', function(e)
//$('.left_controls').bind('click').click(function outside(event) {
//  $('.image_input_form').click(function outside(event){
//  document.getElementById('.image_input_form').onclick = function(event) {
//              console.log("document: click(function(event)");
//
//    if(!$(event.target).closest('.image_input_form').length ) {
//        console.log("document: click: !$(event.target1 closest)");
//    }
//    if(!$(event.target).is('.image_input_form'))  {
//        console.log("document: click: !$(event.target2 is)");
//    }
//    if($('.image_input_form').is(":visible"))  {
//        console.log("document: click: !$(event.target3) is(:visible");
//    }
//    if(!$(event.target).is('.image_input_form'))
//    {
//        console.log("document: click: !$(event.target3) is .image_input_form");
//    }
//
//
//    if(!$(event.target).closest('.image_input_form').length &&
//            !$(event.target).is('.image_input_form')) {
//        console.log("document: click: !$(event.target)");
//
//        if($('.image_input_form').is(":visible")) {
//            $('.image_input_form').empty().html("< %= j render 'upload_both_ways' -%>");
////            $('#menucontainer').hide();
//        }
//    }
//    event.stopPropagation();
//});
